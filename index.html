<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    </head>
    <body>
        <div style="padding: 20px;">
            <canvas id="canvas"></canvas>
        </div>
        <script>
            const url = 'https://services1.arcgis.com/WzFsmainVTuD5KML/arcgis/rest/services/cumulative_cases/FeatureServer/0/query'
                + '?where=1%3D1'
                + '&resultType=none'
                + '&outFields=date_%2C+daily_cases%2C+economic_region'
                + '&returnIdsOnly=false'
                + '&returnUniqueIdsOnly=false'
                + '&returnCountOnly=false'
                + '&returnDistinctValues=false'
                + '&cacheHint=false'
                + '&sqlFormat=none'
                + '&f=json'

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const EARLIEST_DATE = '2020-05-01'

                    const state_data = data.features
                        .map(f => f.attributes)
                        .filter(d => d.Economic_Region === 'Statewide')
                        .filter(d => d.Date_ > (new Date(EARLIEST_DATE)).valueOf())
                        .map(i => ({x: (new Date(i.Date_)).toISOString().split('T')[0], y: i.daily_cases}))

                    const anchorage_data = data.features
                        .map(f => f.attributes)
                        .filter(d => d.Economic_Region === 'Anchorage')
                        .filter(d => d.Date_ > (new Date(EARLIEST_DATE)).valueOf())
                        .map(i => ({x: (new Date(i.Date_)).toISOString().split('T')[0], y: i.daily_cases}))


                    // force another day at the end (because the chart cuts off the last day otherwise)
                    const ordered_dates = data.features.slice().map(d => d.attributes.Date_).sort()
                    const last_day = new Date(ordered_dates[ordered_dates.length - 1])
                    last_day.setDate(last_day.getDate() + 1)
                    state_data.push({x: last_day.toISOString().split('T')[0], y: 0})
                    anchorage_data.push({x: last_day.toISOString().split('T')[0], y: 0})


                    const ctx = document.getElementById('canvas').getContext('2d');
                    const myLineChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            datasets: [
                                {
                                    label: 'Daily Statewide cases',
                                    backgroundColor: '#f00',
                                    data: state_data,
                                },
                                {
                                    label: 'Daily Anchorage cases',
                                    backgroundColor: '#00f',
                                    data: anchorage_data,
                                }
                            ]
                        },
                        options: {
                            scales: {
                            xAxes: [{
                                type: 'time',
                                gridLines: {
                                    display: false
                                },
                            }],
                        },
                        }
                    });
                });
        </script>
    </body>
</html>
